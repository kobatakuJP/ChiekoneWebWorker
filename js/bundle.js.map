{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/calc.ts","webpack:///./src/main.ts"],"names":[],"mappings":"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","file":"bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/main.ts\");\n","interface WorkArg {\r\n    indices: Indices;\r\n    csvBuf: SharedArrayBuffer;\r\n}\r\n\r\n/** 配列の対象インデックス、開始終了 */\r\ninterface Indices {\r\n    startI: number;\r\n    endI: number;\r\n}\r\n\r\nexport class CsvCalc {\r\n    /** 入力元CSV */\r\n    csv: string;\r\n    /** CSVを一文字ずつの配列にしたもの。𩸽対策で文字単位で入れたいため。 */\r\n    csvArr: string[];\r\n    /** Workerとメモリシェアするために */\r\n    buf: SharedArrayBuffer;\r\n    /** SharedArrayBufferを使うためのView */\r\n    bufView: Float32Array;\r\n    static SEPARATOR: string = \"\\n\";\r\n    /** ワーカが処理するレコードの単位 */\r\n    static WORK_UNIT_NUM: number = 1000 * 10;\r\n    calc(csv: string) {\r\n        this.csv = csv;\r\n        this.csvToBuf();\r\n    }\r\n    getAve(cellNum: Number) {\r\n        /** 前のループの改行の次の文字のインデックス */\r\n        let lastStart = 0;\r\n        /** レコード数チェック変数 */\r\n        let recordCount = 0;\r\n        for (let csvI = 0, csvL = this.csvArr.length; csvI < csvL; csvI++) {\r\n            if (CsvCalc.SEPARATOR === this.csvArr[csvI][0]) {\r\n                recordCount++;\r\n                if (recordCount === CsvCalc.WORK_UNIT_NUM) {\r\n                    this.doWorker(lastStart, csvI);\r\n                    recordCount = 0;\r\n                    lastStart = csvI + 1; // 改行の一つ後ろの文字からやるために\r\n                }\r\n            }\r\n        }\r\n        this.doWorker(lastStart, this.csvArr.length); // ぴったり終わることなんてないので最後の分を送る\r\n    }\r\n    doWorker(s: number, e: number) {\r\n        // TypedArray.prototype.sliceは結局コピーなのでもったいない。開始終了だけ渡す。\r\n        const arg: WorkArg = {\r\n            csvBuf: this.buf,\r\n            indices: {\r\n                startI: s,\r\n                endI: e\r\n            }\r\n        }\r\n    }\r\n    /** 文字列をバッファに変換する */\r\n    csvToBuf() {\r\n        // 一文字ごとの配列にする。\r\n        this.csvArr = Array.from(this.csv);\r\n        // 一文字4最大バイトなのでlenght*4\r\n        this.buf = new SharedArrayBuffer(this.csvArr.length * 4);\r\n        // ArrayBufferをシステムで扱うためにviewを作成\r\n        this.bufView = new Float32Array(this.buf);\r\n        for (let i = 0, l = this.bufView.length; i < l; i++) {\r\n            this.bufView[i] = this.csvArr[i].codePointAt(0);\r\n        }\r\n    }\r\n}\r\n\r\n/** 普通にfor文で計算するパティーン */\r\nexport function normalCalc(csv: string, targetCellNum: number): { result: number, num: number } {\r\n    const CSV_SEP = \",\";\r\n    const csvArr: string[] = Array.from(csv);\r\n    let calcArr: number[] = [];\r\n    console.time(\"calctime\");\r\n    for (let i = 0, l = csvArr.length, cellNum = 0, currentCellStartI = 0; i < l; i++) {\r\n        switch (csvArr[i]) {\r\n            case CSV_SEP:\r\n            case CsvCalc.SEPARATOR:\r\n                // セルの終わりなので、現在のセル確認\r\n                if (cellNum === targetCellNum) {\r\n                    // 現在ターゲットセルにいれば、中身を計算対象に入れる(数値じゃない可能性は・・無視！！)\r\n                    calcArr.push(parseFloat((csvArr.slice(currentCellStartI, i - 1).join(\"\")).replace(/^\\\"+|\\\"+$/g, \"\")));\r\n                }\r\n                currentCellStartI = i + 1; // 次の文字がセル開始位置\r\n                if (csvArr[i] === CSV_SEP) {\r\n                    // セル区切りなのでセル番を更新\r\n                    cellNum++;\r\n                } else if (csvArr[i] === CsvCalc.SEPARATOR) {\r\n                    // 行区切りなので、セル番をリセット\r\n                    cellNum = 0;\r\n                }\r\n                break;\r\n            default:\r\n        }\r\n    }\r\n    console.timeEnd(\"calctime\");\r\n    return { result: Ave(calcArr), num: calcArr.length };\r\n}\r\n\r\nfunction Ave(calcArr: number[]): number {\r\n    let sum = 0;\r\n    for (let i = 0, l = calcArr.length; i < l; i++) {\r\n        if (!isNaN(calcArr[i])) {\r\n            // NaNじゃないやつだけ計算対象にする。つまりNaNは実質０としてカウントされ、割り算に影響する。\r\n            sum += calcArr[i];\r\n        }\r\n    }\r\n    return sum / calcArr.length;\r\n}","import * as calc from \"./calc\";\r\n\r\nlet w = new Worker(\"worker.js\");\r\nlet w2 = new Worker(\"worker.js\");\r\nconst wb = document.getElementById(\"workbtn\");\r\nconst cg = document.getElementById(\"csvget\");\r\nlet sb = new SharedArrayBuffer(12);\r\nlet bufView = new Float32Array(sb);\r\n\r\nwb.onclick = function () {\r\n    w.postMessage(sb);\r\n    setTimeout(function () {\r\n        for (let i = 0; i < 10; i++) {\r\n            console.log(bufView[i])\r\n        }\r\n    }, 1000)\r\n};\r\n\r\ncg.onclick = function () {\r\n    const a = new XMLHttpRequest();\r\n    a.open(\"GET\", \"http://127.0.0.1:8000/bigfile/rice.csv\", true);\r\n    a.send();\r\n    a.onreadystatechange = function() {\r\n        if (a.readyState === XMLHttpRequest.DONE) {\r\n            console.time(\"total\");\r\n            let result = calc.normalCalc(a.responseText, 5);\r\n            console.timeEnd(\"total\");\r\n            console.log(\"num:\" + result.num + \", ave:\" + result.result);\r\n        }\r\n    }\r\n}"],"sourceRoot":""}